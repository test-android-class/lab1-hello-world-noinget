name: Auto Grade

on: [push]

jobs:
  grade:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Compile
        run: javac app/src/main/java/com/example/MainActivity.java 2>&1 | tee compile_log.txt
        continue-on-error: true

      - name: Ask Claude for feedback
        env:
          BEDROCK_API_KEY: ${{ secrets.BEDROCK_API_KEY }}
        run: |
          LOG=$(cat compile_log.txt | head -20 | tr '"' "'" | tr '\n' ' ')
          CODE=$(cat app/src/main/java/com/example/MainActivity.java | tr '"' "'" | tr '\n' ' ')
          curl -s -X POST \
            -H "Authorization: Bearer $BEDROCK_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"anthropic_version\":\"bedrock-2023-05-31\",\"max_tokens\":300,\"messages\":[{\"role\":\"user\",\"content\":\"你是Android課助教，用繁體中文給學生一句作業回饋。編譯結果：$LOG 程式碼：$CODE\"}]}" \
            "https://bedrock-runtime.us-east-1.amazonaws.com/model/us.anthropic.claude-haiku-4-5-20251001-v1%3A0/invoke" \
            | tee claude_feedback.txt

      - name: Upload feedback
        uses: actions/upload-artifact@v4
        with:
          name: claude-feedback
          path: claude_feedback.txt

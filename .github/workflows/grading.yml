name: Auto Grade

on: [push]

jobs:
  grade:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Compile
      run: |
        javac app/src/main/java/com/example/MainActivity.java 2>&1 | tee compile_log.txt
        if javac app/src/main/java/com/example/MainActivity.java 2>/dev/null; then
          echo "COMPILE_STATUS=成功" >> $GITHUB_ENV
        else
          echo "COMPILE_STATUS=失敗" >> $GITHUB_ENV
        fi
      continue-on-error: true

    - name: Ask Claude for feedback
      env:
        BEDROCK_API_KEY: ${{ secrets.BEDROCK_API_KEY }}
      run: |
        COMPILE_LOG=$(cat compile_log.txt | head -20)
        STUDENT_CODE=$(cat app/src/main/java/com/example/MainActivity.java)
        PAYLOAD=$(jq -n --arg log "$COMPILE_LOG" --arg code "$STUDENT_CODE" '{"anthropic_version":"bedrock-2023-05-31","max_tokens":300,"messages":[{"role":"user","content":("你是Android程式設計課助教，請用繁體中文給學生簡短作業回饋並鼓勵。編譯結果："+$log+"程式碼："+$code)}]}')
        curl -s -X POST \
          -H "Authorization: Bearer $BEDROCK_API_KEY" \
          -H "Content-Type: application/json" \
          -d "$PAYLOAD" \
          "https://bedrock-runtime.us-east-1.amazonaws.com/model/us.anthropic.claude-haiku-4-5-20251001-v1%3A0/invoke" \
          | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['content'][0]['text'] if 'content' in d else str(d))" > claude_comment.txt
        cat claude_comment.txt

    - name: Post feedback to GitHub Issue
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        FEEDBACK=$(cat claude_comment.txt)
        COMMIT=$(git rev-parse --short HEAD)
        gh issue create --title "作業回饋 Commit $COMMIT" --body "## 編譯狀態：$COMPILE_STATUS\n\n### Claude 助教評語\n$FEEDBACK\n\n*此評語由 AI 自動產生*"

    - name: Upload feedback
      uses: actions/upload-artifact@v4
      with:
        name: claude-feedback
        path: claude_comment.txt

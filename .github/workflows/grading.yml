name: Auto Grade

on: [push]

jobs:
  grade:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Compile
      run: |
        javac app/src/main/java/com/example/MainActivity.java 2>&1 | tee compile_log.txt
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "COMPILE_STATUS=âœ… ç·¨è­¯æˆåŠŸ" >> $GITHUB_ENV
        else
          echo "COMPILE_STATUS=âŒ ç·¨è­¯å¤±æ•—" >> $GITHUB_ENV
        fi
      continue-on-error: true

    - name: Ask Claude for feedback
      env:
        BEDROCK_API_KEY: ${{ secrets.BEDROCK_API_KEY }}
      run: |
        COMPILE_LOG=$(cat compile_log.txt | head -20)
        STUDENT_CODE=$(cat app/src/main/java/com/example/MainActivity.java)
        
        PAYLOAD=$(jq -n \
          --arg log "$COMPILE_LOG" \
          --arg code "$STUDENT_CODE" \
          '{
            "anthropic_version": "bedrock-2023-05-31",
            "max_tokens": 300,
            "messages": [{
              "role": "user",
              "content": ("ä½ æ˜¯Androidç¨‹å¼è¨­è¨ˆèª²åŠ©æ•™ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡çµ¦å­¸ç”Ÿç°¡çŸ­ä½œæ¥­å›é¥‹ï¼ŒåŒ…å«é¼“å‹µã€‚\nç·¨è­¯çµæœï¼š" + $log + "\nç¨‹å¼ç¢¼ï¼š" + $code)
            }]
          }')
        
        RESPONSE=$(curl -s \
          -X POST \
          -H "Authorization: Bearer $BEDROCK_API_KEY" \
          -H "Content-Type: application/json" \
          -d "$PAYLOAD" \
          "https://bedrock-runtime.us-east-1.amazonaws.com/model/us.anthropic.claude-haiku-4-5-20251001-v1%3A0/invoke")
        
        echo "$RESPONSE" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if 'content' in data:
    print(data['content'][0]['text'])
" > claude_comment.txt
        
        cat claude_comment.txt

    - name: Post feedback to GitHub Issue
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        FEEDBACK=$(cat claude_comment.txt)
        COMMIT=$(git rev-parse --short HEAD)
        
        gh issue create \
          --title "ä½œæ¥­å›é¥‹ - Commit $COMMIT" \
          --body "## $COMPILE_STATUS

### ğŸ“ Claude åŠ©æ•™è©•èª
$FEEDBACK

---
*æ­¤è©•èªç”± AI è‡ªå‹•ç”¢ç”Ÿï¼Œåƒ…ä¾›åƒè€ƒ*" \
          --label "feedback" || true

    - name: Upload feedback
      uses: actions/upload-artifact@v4
      with:
        name: claude-feedback
        path: claude_comment.txt

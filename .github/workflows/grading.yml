name: Auto Grade

on: [push]

jobs:
  grade:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Compile
      run: |
        javac app/src/main/java/com/example/MainActivity.java 2>&1 | tee compile_log.txt
      continue-on-error: true

    - name: Ask Claude for feedback
      env:
        BEDROCK_API_KEY: ${{ secrets.BEDROCK_API_KEY }}
      run: |
        COMPILE_LOG=$(cat compile_log.txt | head -20)
        STUDENT_CODE=$(cat app/src/main/java/com/example/MainActivity.java)
        
        PAYLOAD=$(jq -n \
          --arg log "$COMPILE_LOG" \
          --arg code "$STUDENT_CODE" \
          '{
            "anthropic_version": "bedrock-2023-05-31",
            "max_tokens": 300,
            "messages": [{
              "role": "user",
              "content": ("你是Android程式設計課助教，請用繁體中文給學生一句簡短作業回饋。\n編譯結果：" + $log + "\n程式碼：" + $code)
            }]
          }')
        
        curl -s \
          -X POST \
          -H "Authorization: Bearer $BEDROCK_API_KEY" \
          -H "Content-Type: application/json" \
          -d "$PAYLOAD" \
          "https://bedrock-runtime.us-east-1.amazonaws.com/model/anthropic.claude-haiku-4-5-20251001-v1%3A0/invoke" \
          | tee claude_feedback.txt
        
        echo "=== Claude 評語 ==="
        cat claude_feedback.txt | python3 -c "
import sys, json
data = json.load(sys.stdin)
if 'content' in data:
    print(data['content'][0]['text'])
else:
    print(data)
"

    - name: Upload feedback
      uses: actions/upload-artifact@v4
      with:
        name: claude-feedback
        path: claude_feedback.txt
